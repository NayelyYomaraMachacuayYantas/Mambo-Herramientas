<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAMBO — Tienda Urbana (Oscuro)</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Fuente moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet" />
  <link th:href="@{/css/listaProductos.css}" rel="stylesheet" />
</head>

<body>
  <div th:replace="client/fragments/navbar :: navbarFragment"></div>

  <!-- SITE CONTENT -->
  <div class="site-container">
    <div class="hero" role="banner" aria-label="Banner principal">
      <h1>Encuentra tu estilo</h1>
    </div>

    <!-- MAIN GRID -->
    <div class="main-grid">
      <!-- SIDEBAR FILTER -->
      <aside class="sidebar d-none d-md-block" aria-label="Filtros">
        <h5>Filtrar</h5>
        <label class="muted">Categorías</label>
        <button class="category-btn" data-cat="Poleras">Poleras</button>
        <button class="category-btn" data-cat="Chaquetas">Chaquetas</button>
        <button class="category-btn" data-cat="Pantalones">Pantalones</button>
        <button class="category-btn" data-cat="Shorts">Shorts</button>
        <button class="category-btn" data-cat="Accesorios">Accesorios</button>
        <button class="category-btn" data-cat="Ofertas">Ofertas</button>
        <hr style="border-color: rgba(255, 255, 255, 0.03)" />
        <label class="muted">Precio (S/)</label>
        <div class="price-range">
          <input id="minPrice" type="number" placeholder="Mín" min="0" />
          <input id="maxPrice" type="number" placeholder="Máx" min="0" />
        </div>
        <div style="margin-top: 10px">
          <button id="applyFilter" class="category-btn" style="background: var(--accent); color: #050506">Aplicar</button>
          <button id="clearFilter" class="category-btn" style="margin-top: 6px">Limpiar filtros</button>
        </div>
      </aside>

      <!-- CATALOG + PRODUCTS -->
      <section class="catalogo">
        <div class="catalog-top">
          <div class="catalog-title">Catálogo</div>
          <div class="search-box" role="search" aria-label="Buscar productos">
            <input id="searchInput" placeholder="Buscar por nombre..." />
            <button id="searchBtn" title="Buscar"><i class="bi bi-search"></i></button>
          </div>
        </div>

        <!-- OFFCANVAS FILTROS MÓVIL -->
        <button class="btn btn-outline-warning d-md-none mb-3" data-bs-toggle="offcanvas" data-bs-target="#offcanvasFiltro">
          <i class="bi bi-funnel"></i> Filtros
        </button>
        <div class="offcanvas offcanvas-start bg-dark text-white d-block d-md-none" tabindex="-1" id="offcanvasFiltro">
          <div class="offcanvas-header border-bottom border-secondary">
            <h5 class="offcanvas-title text-uppercase text-warning">Filtrado</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
          </div>
          <div class="offcanvas-body">
            <label class="muted">Categorías</label>
            <button class="category-btn" data-cat="Poleras">Poleras</button>
            <button class="category-btn" data-cat="Chaquetas">Chaquetas</button>
            <button class="category-btn" data-cat="Pantalones">Pantalones</button>
            <button class="category-btn" data-cat="Shorts">Shorts</button>
            <button class="category-btn" data-cat="Accesorios">Accesorios</button>
            <button class="category-btn" data-cat="Ofertas">Ofertas</button>
            <hr style="border-color: rgba(255, 255, 255, 0.03)" />
            <label class="muted">Precio (S/)</label>
            <div class="price-range">
              <input id="minPriceMobile" type="number" placeholder="Mín" min="0" />
              <input id="maxPriceMobile" type="number" placeholder="Máx" min="0" />
            </div>
            <div style="margin-top: 10px">
              <button id="applyFilterMobile" class="category-btn" style="background: var(--accent); color: #050506">Aplicar</button>
              <button id="clearFilterMobile" class="category-btn" style="margin-top: 6px">Limpiar filtros</button>
            </div>
          </div>
        </div>

        <!-- PRODUCT GRID -->
        <div id="productsGrid" class="products-grid">
          <div th:each="producto : ${productos}" class="card-product">
            <div class="media">
              <img th:src="@{/img/{file}(file=${producto.imagenUrl})}" th:alt="${producto.nombre}" />
            </div>
            <div class="body">
              <div>
                <div class="product-title" th:text="${producto.nombre}"></div>
                <div class="product-sub muted">Categoría: <span th:text="${producto.categoria}"></span></div>
                <div class="product-sub muted">Stock: <span th:text="${producto.stock}"></span></div>
              </div>
              <div class="price-row">
                <div class="price">S/ <span th:text="${producto.precio}"></span></div>
                <button class="add-btn" th:attr="data-id=${producto.id}, data-nombre=${producto.nombre}, data-precio=${producto.precio}, data-img=${producto.imagenUrl}">Agregar</button>
              </div>
            </div>
          </div>
        </div>

        <hr class="mx-2 mt-5" />
        <h4>CATEGORIAS A ELEGIR</h4>
        <div class="chips">
          <div class="chip" data-cat="Poleras">Poleras</div>
          <div class="chip" data-cat="Chaquetas">Chaquetas</div>
          <div class="chip" data-cat="Pantalones">Pantalones</div>
          <div class="chip" data-cat="Shorts">Shorts</div>
          <div class="chip" data-cat="Accesorios">Accesorios</div>
          <div class="chip" data-cat="Ofertas">Ofertas</div>
        </div>
      </section>
    </div>
  </div>

  <!-- OFFCANVAS CART -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartCanvas" aria-labelledby="cartLabel">
    <div class="offcanvas-header">
      <h5 id="cartLabel" class="offcanvas-title">Tu Carrito</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
      <div id="cartItemsArea">
        <p class="muted">No hay productos en el carrito.</p>
      </div>
      <div class="mt-3 text-end">
        <div class="muted">Total</div>
        <div id="cartTotal" style="font-weight: 900; font-size: 1.15rem; margin-top: 0.25rem">S/ 0.00</div>
        <button id="checkoutBtn" class="add-btn w-100 mt-3">Finalizar compra</button>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="site-container">
      <div class="row">
        <div class="col-md-6 mb-3">
          <h6>Ubicación</h6>
          <p class="muted">Multicentro - Santa Clara - Ate<br />Tiendas N°05-393</p>
          <a href="https://www.google.com/maps?q=Multicentro+Santa+Clara+Ate" target="_blank" rel="noopener" class="muted">Ver en Google Maps →</a>
        </div>
        <div class="col-md-6">
          <h6>Contacto</h6>
          <p class="muted"><i class="bi bi-telephone"></i> +51 923123890<br /><i class="bi bi-envelope"></i> MamboClothing@gmail.com</p>
          <div style="margin-top: 0.5rem">
            <a class="muted me-3" href="#"><i class="bi bi-facebook fs-4"></i></a>
            <a class="muted me-3" href="#"><i class="bi bi-instagram fs-4"></i></a>
            <a class="muted" href="#"><i class="bi bi-tiktok fs-4"></i></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JS Carrito y filtros -->
  <script>
    // ===== Carrito persistente =====
    let cart = JSON.parse(localStorage.getItem('mambo_cart_v1') || '[]');
    const cartItemsArea = document.getElementById('cartItemsArea');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartBadge = document.getElementById('cartBadge');

    function saveCart(){ localStorage.setItem('mambo_cart_v1', JSON.stringify(cart)); }
    function getCartCount(){ return cart.reduce((s,i)=>s+(i.qty||0),0); }

    function addToCart(product){
      const existing = cart.find(i=>i.id===product.id);
      if(existing) existing.qty+=1;
      else cart.push({...product, qty:1});
      saveCart(); updateCartUI();
      bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('cartCanvas')).show();
    }

    function removeFromCart(id){
      cart = cart.filter(i=>i.id!==id);
      saveCart(); updateCartUI();
    }

    function changeQty(id, delta){
      const it = cart.find(i=>i.id===id); if(!it) return;
      it.qty+=delta; if(it.qty<1) it.qty=1;
      saveCart(); updateCartUI();
    }

    function computeTotal(){ return cart.reduce((s,i)=>s+i.price*i.qty,0); }

    function updateCartUI(){
      if(cartBadge) cartBadge.textContent = getCartCount();
      cartItemsArea.innerHTML = '';
      if(cart.length===0){ cartItemsArea.innerHTML='<p>No hay productos en el carrito.</p>'; return; }

      cart.forEach(item=>{
        const div=document.createElement('div');
        div.className='cart-item';
        div.innerHTML=`
          <img src="${item.img}" alt="${item.name}" />
          <div>
            <h6>${item.name}</h6>
            <p>Unit: S/ ${item.price.toFixed(2)}</p>
            <div>
              <button class="btn-decrease" data-id="${item.id}">−</button>
              <span>${item.qty}</span>
              <button class="btn-increase" data-id="${item.id}">+</button>
            </div>
          </div>
          <div>S/ ${(item.price*item.qty).toFixed(2)}
            <button class="remove-btn" data-id="${item.id}">Eliminar</button>
          </div>
        `;
        cartItemsArea.appendChild(div);
      });

      cartItemsArea.querySelectorAll('.btn-decrease').forEach(b=>b.addEventListener('click', e=>changeQty(e.currentTarget.dataset.id,-1)));
      cartItemsArea.querySelectorAll('.btn-increase').forEach(b=>b.addEventListener('click', e=>changeQty(e.currentTarget.dataset.id,+1)));
      cartItemsArea.querySelectorAll('.remove-btn').forEach(b=>b.addEventListener('click', e=>removeFromCart(e.currentTarget.dataset.id)));

      cartTotalEl.textContent = computeTotal().toFixed(2);
    }

    // Delegación para botones "Agregar"
    document.addEventListener('click', e=>{
      const addBtn = e.target.closest('.add-btn');
      if(addBtn){
        const product={
          id:addBtn.dataset.id,
          name:addBtn.dataset.nombre,
          price:parseFloat(addBtn.dataset.precio),
          img:addBtn.dataset.img
        };
        addToCart(product);
      }
    });

    document.addEventListener('DOMContentLoaded', updateCartUI);

    // Checkout demo
    document.getElementById('checkoutBtn')?.addEventListener('click', ()=>{
      if(cart.length===0) return alert('Tu carrito está vacío.');
      alert('Compra simulada: total S/ '+computeTotal().toFixed(2));
      cart=[]; saveCart(); updateCartUI();
    });
  </script>
</body>
</html>
